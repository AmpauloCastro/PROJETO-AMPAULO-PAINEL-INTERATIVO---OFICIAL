<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Interativo - Ampaulo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs - Certifique-se de usar suas chaves reais no ambiente local -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        .view { display: none; animation: fadeIn 0.5s ease-in-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Estilos do Bot√£o de Navega√ß√£o Principal */
        .nav-button {
            transition: all 0.3s ease-in-out;
            color: #475569; /* slate-600 */
            border: 2px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }
        .nav-button:hover {
            color: #0d9488; /* teal-600 */
            border-color: #22d3ee; /* cyan-400 */
            background-color: #e0f2f1; /* teal-100 */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .nav-button.active {
            color: #0d9488; /* teal-600 */
            background-color: #e0f2f1; /* teal-100 */
            border-color: #22d3ee; /* cyan-400 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container { position: relative; margin: auto; height: 40vh; width: 100%; max-width: 800px; }
        .workout-accordion-content, .group-accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .workout-accordion-button.open + .workout-accordion-content, .group-accordion-button.open + .group-accordion-content { max-height: 2000px; }
        .run-table thead tr { background-color: #1f2937; color: #ffffff; }
        .run-table tbody tr:nth-child(odd) { background-color: #f8fafc; }
        
        .goal-card.current-month {
            border-width: 2px;
            border-color: #0d9488;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Estilos do Bot√£o de Navega√ß√£o Secund√°ria da Corrida */
        .sub-nav-button {
            transition: all 0.3s ease-in-out;
            border: 2px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: #e2e8f0; /* slate-200 */
            color: #475569; /* slate-600 */
            font-weight: 600;
        }
        .sub-nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .sub-nav-button.active {
            background-color: #0d9488; /* teal-600 */
            color: #ffffff;
            border-color: #22d3ee; /* cyan-400 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .run-content-section {
            display: none;
        }
        .run-content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="app" class="max-w-7xl mx-auto p-4">
        <!-- Cabe√ßalho e Navega√ß√£o -->
        <header class="bg-white rounded-xl shadow p-4 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <h1 class="text-xl font-bold text-slate-800">Painel Fam√≠lia</h1>
                <div id="main-nav" class="flex flex-wrap justify-center sm:justify-start gap-2 sm:gap-4">
                    <button data-target="home" class="nav-button active flex items-center space-x-2">
                        <i data-lucide="home"></i> <span class="hidden sm:inline">Home</span>
                    </button>
                    <button data-target="amanha" class="nav-button flex items-center space-x-2">
                        <i data-lucide="calendar-plus"></i> <span class="hidden sm:inline">Amanh√£</span>
                    </button>
                    <button data-target="treino" class="nav-button flex items-center space-x-2">
                        <i data-lucide="dumbbell"></i> <span class="hidden sm:inline">Treino</span>
                    </button>
                     <button data-target="corrida" class="nav-button flex items-center space-x-2">
                        <i data-lucide="run"></i> <span class="hidden sm:inline">Corrida</span>
                    </button>
                    <button data-target="nutricao" class="nav-button flex items-center space-x-2">
                        <i data-lucide="apple"></i> <span class="hidden sm:inline">Nutri√ß√£o</span>
                    </button>
                    <button data-target="progresso" class="nav-button flex items-center space-x-2">
                        <i data-lucide="bar-chart-3"></i> <span class="hidden sm:inline">Progresso</span>
                    </button>
                    <button data-target="calendario" class="nav-button flex items-center space-x-2">
                        <i data-lucide="calendar-days"></i> <span class="hidden sm:inline">Calend√°rio</span>
                    </button>
                    <button data-target="financas" class="nav-button flex items-center space-x-2">
                        <i data-lucide="dollar-sign"></i> <span class="hidden sm:inline">Finan√ßas</span>
                    </button>
                    <button data-target="prog-distancia" class="nav-button flex items-center space-x-2">
                        <i data-lucide="flag"></i> <span class="hidden sm:inline">Progress√£o</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Conte√∫do Principal -->
        <main>
            <div id="home" class="view active"></div>
            <div id="amanha" class="view"></div>
            <div id="treino" class="view"></div>
            <div id="corrida" class="view"></div>
            <div id="prog-distancia" class="view"></div>
            <div id="nutricao" class="view"></div>
            <div id="progresso" class="view"></div>
            <div id="calendario" class="view"></div>
            <div id="financas" class="view"></div>
        </main>
    </div>

    <!-- Modal -->
    <div id="calendar-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-2xl w-full">
            <h3 id="modal-title" class="text-xl font-bold text-teal-700"></h3>
            <div id="modal-activity" class="text-slate-600 mt-2"></div>
            <p id="modal-motivation" class="text-slate-500 mt-4"></p>
            <p id="modal-verse-ref" class="text-slate-500 italic mt-2"></p>
            <div id="modal-finances" class="mt-4 pt-4 border-t border-slate-200"></div>
            <button id="modal-close" class="mt-6 w-full bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg">Fechar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // --- HELPERS & GLOBAL CONFIGURATION ---
        function getDayName(date) {
            const weekdays = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
            return weekdays[date.getDay()];
        }

        function getMonthName(date) {
            const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return months[date.getMonth()];
        }

        function getLastSaturday(year, month) {
            const date = new Date(year, month + 1, 0); // Last day of the month
            date.setDate(date.getDate() - (date.getDay() + 1) % 7); // Go back to the last Saturday
            return date;
        }

        // --- DATA STORE (Project Data) ---
        const projectData = {
            virtualCoach: {
                paceZones: {
                    Z1: { name: "Z1 ‚Äì Recupera√ß√£o leve", description: "Recupera√ß√£o leve" },
                    Z2: { name: "Z2 ‚Äì Corrida f√°cil / base aer√≥bica", description: "Corrida f√°cil / base aer√≥bica" },
                    Z3: { name: "Z3 ‚Äì Ritmo de limiar baixo / tempo run", description: "Ritmo de limiar baixo / tempo run" },
                    Z4: { name: "Z4 ‚Äì Ritmo de limiar alto / VO‚ÇÇ subm√°x", description: "Ritmo de limiar alto / VO‚ÇÇ subm√°x" },
                    Z5: { name: "Z5 ‚Äì Intervalos curtos / VO‚ÇÇ m√°x", description: "Intervalos curtos / VO‚ÇÇ m√°x" }
                },
                trainingTypes: {
                    intervalado: {
                        name: "Treino 1: Intervalado",
                        description: "4x800m forte + 400m trote",
                        baseDistance: 7.8, // Added for scaling calculation
                        structure: [
                            { phase: "Aquecimento", distance: 1.0, zone: "Z1", description: "Prepara√ß√£o corporal" },
                            { phase: "Aquecimento", distance: 1.0, zone: "Z2", description: "Ativa√ß√£o gradual" },
                            { phase: "S√©rie 1 - 800m", distance: 0.8, zone: "Z4", description: "Primeira s√©rie forte" },
                            { phase: "Recupera√ß√£o 1 - 400m", distance: 0.4, zone: "Z2", description: "Trote de recupera√ß√£o" },
                            { phase: "S√©rie 2 - 800m", distance: 0.8, zone: "Z4", description: "Segunda s√©rie forte" },
                            { phase: "Recupera√ß√£o 2 - 400m", distance: 0.4, zone: "Z2", description: "Trote de recupera√ß√£o" },
                            { phase: "S√©rie 3 - 800m", distance: 0.8, zone: "Z4", description: "Terceira s√©rie forte" },
                            { phase: "Recupera√ß√£o 3 - 400m", distance: 0.4, zone: "Z2", description: "Trote de recupera√ß√£o" },
                            { phase: "S√©rie 4 - 800m", distance: 0.8, zone: "Z4", description: "Quarta s√©rie forte" },
                            { phase: "Recupera√ß√£o 4 - 400m", distance: 0.4, zone: "Z2", description: "Trote de recupera√ß√£o" },
                            { phase: "Desaquecimento", distance: 1.0, zone: "Z1", description: "Volta √† calma" }
                        ]
                    },
                    ritmo: {
                        name: "Treino 2: Ritmo",
                        description: "5km de ritmo cont√≠nuo",
                        baseDistance: 7.0, // Added for scaling calculation
                        structure: [
                            { phase: "Aquecimento", distance: 1.0, zone: "Z1", description: "Prepara√ß√£o" },
                            { phase: "Ritmo 1/5", distance: 1.0, zone: "Z3", description: "Ritmo moderado sustentado" },
                            { phase: "Ritmo 2/5", distance: 1.0, zone: "Z3", description: "Ritmo moderado sustentado" },
                            { phase: "Ritmo 3/5", distance: 1.0, zone: "Z3", description: "Ritmo moderado sustentado" },
                            { phase: "Ritmo 4/5", distance: 1.0, zone: "Z3", description: "Ritmo moderado sustentado" },
                            { phase: "Ritmo 5/5", distance: 1.0, zone: "Z3", description: "Ritmo moderado sustentado" },
                            { phase: "Desaquecimento", distance: 1.0, zone: "Z1", description: "Volta √† calma" }
                        ]
                    },
                    longao: {
                        name: "Treino 3: Long√£o",
                        description: "Dist√¢ncia vari√°vel, ritmo leve",
                        baseDistance: 11, // August 2025
                        monthlyIncrease: 1,
                        startMonth: 7, // August (0-indexed)
                        startYear: 2025
                    },
                    progressivo: {
                        name: "Treino 4: Progressivo",
                        description: "Come√ßa leve, termina mais r√°pido",
                        baseDistance: 6.0, // Added for scaling calculation
                        structure: [
                            { phase: "Aquecimento", distance: 1.0, zone: "Z1", description: "Prepara√ß√£o" },
                            { phase: "Progress√£o 1", distance: 1.0, zone: "Z2", description: "In√≠cio leve" },
                            { phase: "Progress√£o 2", distance: 1.0, zone: "Z3", description: "Acelera√ß√£o gradual" },
                            { phase: "Progress√£o 3", distance: 1.0, zone: "Z4", description: "Ritmo forte" },
                            { phase: "Progress√£o 4", distance: 1.0, zone: "Z4", description: "Manuten√ß√£o forte" },
                            { phase: "Desaquecimento", distance: 1.0, zone: "Z1", description: "Volta √† calma" }
                        ]
                    },
                    fartlek: {
                        name: "Treino 5: Fartlek",
                        description: "Treino progressivo de ritmo",
                        baseDistance: 7.0, // Added for scaling calculation
                        structure: [
                            { phase: "Aquecimento", distance: 1.0, zone: "Z1", description: "Prepara√ß√£o" },
                            { phase: "Bloco 1", distance: 1.0, zone: "Z2", description: "Ritmo leve e constante" },
                            { phase: "Bloco 2", distance: 1.0, zone: "Z3", description: "Aumenta para moderado" },
                            { phase: "Bloco 3", distance: 1.0, zone: "Z4", description: "Aperta para ritmo forte" },
                            { phase: "Bloco 4", distance: 1.0, zone: "Z3", description: "Reduz para moderado" },
                            { phase: "Bloco 5", distance: 1.0, zone: "Z2", description: "Volta para ritmo leve" },
                            { phase: "Desaquecimento", distance: 1.0, zone: "Z1", description: "Volta √† calma" }
                        ]
                    }
                },
                currentWeek: 1, // Alternates between 1 and 2
                lastGeneratedDate: null
            },
            progDistancia: {
                title: "üéØ PROGRESS√ÉO DE PACE E DIST√ÇNCIA",
                description: "Gere seu plano de treino semanal e acompanhe sua evolu√ß√£o para alcan√ßar novas dist√¢ncias e ritmos. A corrida alvo de cada m√™s ser√° no √∫ltimo s√°bado.",
                goals: [
                    { month: 7, year: 2025, distance: 11, label: "Agosto" },
                    { month: 8, year: 2025, distance: 12, label: "Setembro" },
                    { month: 9, year: 2025, distance: 13, label: "Outubro" },
                    { month: 10, year: 2025, distance: 14, label: "Novembro" },
                    { month: 11, year: 2025, distance: 15, label: "Dezembro" }
                ]
            },
            workouts: {
                quarta_inferiores_b: { key: "quarta_inferiores_b", title: "TREINO INFERIORES B ‚Äì QUARTA-FEIRA (28 S√âRIES)", series: 28, objective: "Foco: Quadr√≠ceps, Core e Lombar", groups: [ { name: "Quadr√≠ceps", series: 12, exercises: [ { name: "Agachamento com Barra", sets: "4 s√©ries" }, { name: "Afundo com Halteres", sets: "4 s√©ries" }, { name: "Avan√ßo com Halteres", sets: "4 s√©ries" } ] }, { name: "Core/Abd√¥men", series: 12, exercises: [ { name: "Abdominal Bicicleta", sets: "4 s√©ries" }, { name: "Eleva√ß√£o de Pernas", sets: "4 s√©ries" }, { name: "Crunch Reto", sets: "4 s√©ries" } ] }, { name: "Lombar", series: 4, exercises: [ { name: "Superman (Hiperextens√£o)", sets: "4 s√©ries" } ] } ] },
                sexta_peito_triceps: { key: "sexta_peito_triceps", title: "TREINO PEITO + TR√çCEPS ‚Äì SEXTA-FEIRA (27 S√âRIES)", series: 27, objective: "Desenvolver for√ßa e volume do peitoral e tr√≠ceps.", groups: [ { name: "Peitoral", series: 18, exercises: [ { name: "Supino com Barra", sets: "4 s√©ries" }, { name: "Supino Inclinado com Barra", sets: "4 s√©ries" }, { name: "Crucifixofixo Reto com Halteres", sets: "4 s√©ries" }, { name: "Voador em P√© no Cabo", sets: "3 s√©ries" }, { name: "Voador Curvado em P√© no Cabo", sets: "3 s√©ries" } ] }, { name: "Tr√≠ceps", series: 9, exercises: [ { name: "Tr√≠ceps Franc√™s com Halteres", sets: "3 s√©ries" }, { name: "Tr√≠ceps Invertido na Polia", sets: "3 s√©ries" }, { name: "Tr√≠ceps na Polia", sets: "3 s√©ries" } ] } ] },
                sabado_ombros_trapezio: { key: "sabado_ombros_trapezio", title: "TREINO OMBROS + TRAP√âZIO ‚Äì S√ÅBADO (27 S√âRIES)", series: 27, objective: "Desenvolver ombros largos e trap√©zio definido.", groups: [ { name: "Ombros", series: 18, exercises: [ { name: "Eleva√ß√£o Lateral com Halteres", sets: "3 s√©ries" }, { name: "Eleva√ß√£o Frontal com Placa", sets: "3 s√©ries" }, { name: "Eleva√ß√£o Frontal com Barra", sets: "3 s√©ries" }, { name: "Desenvolvimento com Barra", sets: "3 s√©ries" }, { name: "Crucifixo Inverso com Halteres", sets: "3 s√©ries" }, { name: "Puxada no Rosto no Cabo", sets: "3 s√©ries" } ] }, { name: "Trap√©zio", series: 9, exercises: [ { name: "Encolhimento de Ombros com Halteres", sets: "3 s√©ries" }, { name: "Remada para Cima com Barra", sets: "3 s√©ries" }, { name: "Remada Alta com Barra", sets: "3 s√©ries" } ] } ] },
                domingo_inferiores_a: { key: "domingo_inferiores_a", title: "TREINO INFERIORES A ‚Äì DOMINGO (30 S√âRIES)", series: 30, objective: "Foco: Gl√∫teo, Quadr√≠ceps, Posteriores e Core", groups: [ { name: "Gl√∫teos", series: 6, exercises: [ { name: "Hip Thrust com Barra", sets: "3 s√©ries" }, { name: "Agachamento Sum√¥ com Barra", sets: "3 s√©ries" } ] }, { name: "Posterior de Coxa", series: 6, exercises: [ { name: "Levantamento Terra com Barra", sets: "3 s√©ries" }, { name: "Stiff com Halteres", sets: "3 s√©ries" } ] }, { name: "Panturrilhas", series: 6, exercises: [ { name: "Panturrilha no Step com Halteres", sets: "3 s√©ries" }, { name: "Panturrilha no Smith", sets: "3 s√©ries" } ] }, { name: "Core/Abd√¥men", series: 12, exercises: [ { name: "Eleva√ß√£o de Pernas", sets: "4 s√©ries" }, { name: "Crunch Reto", sets: "4 s√©ries" }, { name: "Abdominal Bicicleta", sets: "4 s√©ries" } ] } ] },
                segunda_costas_antebraco_biceps: { key: "segunda_costas_antebraco_biceps", title: "TREINO COSTAS + ANTEBRA√áO + B√çCEPS ‚Äì SEGUNDA-FEIRA (30 S√âRIES)", series: 30, objective: "Desenvolver for√ßa e volume em costas, antebra√ßos e b√≠ceps.", groups: [ { name: "Costas", series: 20, exercises: [ { name: "Remada Curvada com Barra", sets: "4 s√©ries" }, { name: "Remada Curvada (Pegada Invertida)", sets: "4 s√©ries" }, { name: "Puxada Lateral (Pegada Aberta)", sets: "4 s√©ries" }, { name: "Puxada Lateral (Pegada Invertida)", sets: "4 s√©ries" }, { name: "Remada Sentado no Cabo", sets: "4 s√©ries" } ] }, { name: "Antebra√ßo", series: 4, exercises: [ { name: "Rosca Punho", sets: "2 s√©ries" }, { name: "Rosca Inversa", sets: "2 s√©ries" } ] }, { name: "B√≠ceps", series: 6, exercises: [ { name: "Rosca Direta com Barra", sets: "3 s√©ries" }, { name: "Rosca Alternada com Halteres", sets: "3 s√©ries" } ] } ] }
            },
            runs: {
                paceDefinitionsAmpaulo: [ 
                    { name: "Z1 ‚Äì Recupera√ß√£o leve", min_km: "6:29", max_km: "7:19", min_kmh: 8.20, max_kmh: 9.25, description: "Recupera√ß√£o leve" },
                    { name: "Z2 ‚Äì Corrida f√°cil / base aer√≥bica", min_km: "5:55", max_km: "6:29", min_kmh: 9.25, max_kmh: 10.14, description: "Corrida f√°cil / base aer√≥bica" },
                    { name: "Z3 ‚Äì Ritmo de limiar baixo / tempo run", min_km: "5:31", max_km: "5:55", min_kmh: 10.14, max_kmh: 10.88, description: "Ritmo de limiar baixo / tempo run" },
                    { name: "Z4 ‚Äì Ritmo de limiar alto / VO‚ÇÇ subm√°x", min_km: "5:05", max_km: "5:31", min_kmh: 10.88, max_kmh: 11.80, description: "Ritmo de limiar alto / VO‚ÇÇ subm√°x" },
                    { name: "Z5 ‚Äì Intervalos curtos / VO‚ÇÇ m√°x", min_km: "4:31", max_km: "5:05", min_kmh: 11.80, max_kmh: 13.28, description: "Intervalos curtos / VO‚ÇÇ m√°x" }
                ],
                paceDefinitionsEloisa: [ { name: "Zona 1 (Z1) - Recupera√ß√£o Ativa", min_km: "8:31", max_km: "9:30", min_kmh: 6.31, max_kmh: 7.05, description: "Ritmo muito leve" }, { name: "Zona 2 (Z2) - Ritmo Leve", min_km: "7:45", max_km: "8:30", min_kmh: 7.06, max_kmh: 7.74, description: "Conversa confort√°vel" }, { name: "Zona 3 (Z3) - Ritmo Moderado", min_km: "7:00", max_km: "7:30", min_kmh: 8.00, max_kmh: 8.57, description: "Conversa um pouco dif√≠cil" }, { name: "Zona 4 (Z4) - Ritmo Forte", min_km: "6:00", max_km: "6:30", min_kmh: 9.23, max_kmh: 10.00, description: "Alta intensidade, respira√ß√£o ofegante" }, { name: "Zona 5 (Z5) - Ritmo M√°ximo/Sprint", min_km: "5:00", max_km: "5:59", min_kmh: 10.01, max_kmh: 12.00, description: "Esfor√ßo m√°ximo" } ],
                // These will be dynamically updated by generateAndStoreScaledRunPlans()
                // Initial empty objects are fine as they will be populated.
                ampaulo_intervalado: {},
                ampaulo_ritmo: {},
                ampaulo_longao: {},
                ampaulo_progressivo: {},
                ampaulo_fartlek: {},
                segunda_eloisa: { title: "üèÉ‚Äç‚ôÄÔ∏è SEGUNDA ‚Äì TREINO DE CORRIDA ELO√çSA (50 MIN)", stages: [ { name: "Aquecimento", duration: "10 min", pace: "Caminhada leve üö∂‚Äç‚ôÄÔ∏è" }, { name: "Parte Principal", duration: "8 ciclos de (1 min corrida leve üèÉ‚Äç‚ôÄÔ∏è + 2 min caminhada üö∂‚Äç‚ôÄÔ∏è)", pace: "Ritmo do corpo" }, { name: "Desaquecimento", duration: "6 min", pace: "Caminhada leve üö∂‚Äç‚ôÄÔ∏è" } ], total: { duration: "50 minutos", distance: "N/A" } },
                quarta_eloisa: { title: "üèÉ‚Äç‚ôÄÔ∏è QUARTA ‚Äì TREINO DE CORRIDA ELO√çSA (50 MIN)", stages: [ { name: "Aquecimento", duration: "10 min", pace: "Caminhada leve üö∂‚Äç‚ôÄÔ∏è" }, { name: "Parte Principal", duration: "10 ciclos de (1 min 30s corrida üèÉ‚Äç‚ôÄÔ∏è + 2 min caminhada üö∂‚Äç‚ôÄÔ∏è)", pace: "Ritmo do corpo" }, { name: "Desaquecimento", duration: "5 min", pace: "Caminhada leve üö∂‚Äç‚ôÄÔ∏è" } ], total: { duration: "50 minutos", distance: "N/A" } },
                sabado_eloisa: { title: "üèÉ‚Äç‚ôÄÔ∏è S√ÅBADO ‚Äì TREINO DE CORRIDA ELO√çSA (70 MIN)", stages: [ { name: "Aquecimento", duration: "10 min", pace: "Caminhada leve üö∂‚Äç‚ôÄÔ∏è" }, { name: "Parte Principal", duration: "10 ciclos de (2 min corrida üèÉ‚Äç‚ôÄÔ∏è + 2 min caminhada üö∂‚Äç‚ôÄÔ∏è)", pace: "Ritmo do corpo" }, { name: "Desaquecimento", duration: "10 min", pace: "Caminhada leve üö∂‚Äç‚ôÄÔ∏è" } ], total: { duration: "70 minutos", distance: "N/A" } }
            },
            nutrition: {
                professional: "K√©zia Rocha",
                objective: "REEDUCA√á√ÉO ALIMENTAR / EMAGRECIMENTO / MELHORA DA IMUNIDADE",
                generalInfo: [
                    "Evitar refrigerante, excesso de doces, caf√© com a√ß√∫car, embutidos, frituras, comidas gordurosas.",
                    "Praticar exerc√≠cio f√≠sico no m√≠nimo 4x na semana.",
                    "Hidrata√ß√£o di√°ria: 3.4 litros. Aumentar o consumo gradualmente.",
                    "Comer devagar, mastigar bem e prestar aten√ß√£o aos sinais de saciedade.",
                    "Permitido at√© duas refei√ß√µes livres na semana (ex: pizza, hamb√∫rguer, etc., com modera√ß√£o)."
                ],
                meals: [
                    { time: "08:00", name: "Caf√© da Manh√£", items: [
                        { icon: 'ü•ö', item: "Ovo de galinha", amount: "3 Unidades (150g)", notes: "Pode ser mexido, cozido, frito ou omelete.", substitutes: null },
                        { icon: 'üåΩ', item: "Cuscuz de milho cozido", amount: "200g", substitutes: "Banana da terra cozida (180g), P√£o de forma (3 fatias, 75.4g), P√£o franc√™s (80g), Mandioca cozida (180g)" },
                        { icon: 'üçà', item: "Mel√£o", amount: "300g", substitutes: "Banana prata (80g), Laranja (180g), Ma√ß√£ (130g), Manga (120g), Uva (120g), Abacaxi (170g), Mam√£o (170g)" },
                        { icon: '‚òï', item: "Caf√© coado (suave)", amount: "1 X√≠cara (200ml)", substitutes: null }
                    ]},
                    { time: "12:10", name: "Almo√ßo", items: [
                        { icon: 'üçö', item: "Arroz branco ou integral", amount: "8 Colheres de sopa (200g)", substitutes: "Batata inglesa cozida (480g)" },
                        { icon: 'üç≤', item: "Feij√£o carioca/preto", amount: "1.5 Concha (210g)", substitutes: null },
                        { icon: 'ü•¶', item: "Legumes e vegetais ao vapor", amount: "4 colheres de sopa (120g)", substitutes: null },
                        { icon: 'ü•ó', item: "Salada colorida sem fruta", amount: "√Ä vontade", substitutes: null },
                        { icon: 'üçó', item: "Peito de frango sem pele cozido", amount: "1.2 Fil√©s m√©dios (120g)", substitutes: "Sobrecoxa de frango (78g), F√≠gado bovino (90g), Carne magra refogada (110g), Coxa de frango (120g)" }
                    ]},
                    { time: "16:30", name: "Lanche", items: [
                        { icon: 'üçà', item: "Mel√£o", amount: "300g", substitutes: "Banana prata (80g), Laranja (180g), Ma√ß√£ (130g), Manga (120g), Uva (120g), Abacaxi (170g), Mam√£o (170g)" }
                    ]},
                    { time: "20:00", name: "Jantar", items: [
                        { icon: 'üåΩ', item: "Cuscuz de milho cozido", amount: "200g", substitutes: "Banana da terra cozida (180g), P√£o de forma (3 fatias, 75.4g), P√£o franc√™s (80g), Mandioca cozida (180g)" },
                        { icon: 'ü•©', item: "Peito de frango ou carne magra", amount: "1.3 Fil√©s m√©dios (130g)", substitutes: null }
                    ]}
                ]
            },
            progress: { 
                dates: ['10/01/2024', '31/07/2024', '05/05/2025', '15/07/2025'], 
                weight: [98.7, 92.8, 96.8, 96.2], 
                fatPercentage: [24.9, 16.4, 19.5, 15.1], 
                fatMass: [24.5, 15.3, 18.9, 14.5], 
                leanMass: [74.2, 77.5, 77.9, 81.7], 
                waist: [93, 87, 93, 93], 
                abdomen: [100, 93, 96, 99], 
                skinfolds: { 
                    labels: ['Tricipital', 'Abdominal', 'Subescapular', 'Axilar M√©dia', 'Tor√°cica', 'Suprail√≠aca'], 
                    data: [ 
                        [45, 40, 35, 25, 20, 20], 
                        [11.2, 30, 23.6, 12.4, 9.5, 14.7], 
                        [12, 32, 30, 16, 15, 20],
                        [8.8, 20, 17.7, 3.8, 11.9, 23.5]
                    ] 
                } 
            },
            calendarActivities: {
                0: { activity: "MUSCULA√á√ÉO: TREINO INFERIORES A", msg: "Um novo ciclo de for√ßa come√ßa hoje! D√™ o seu melhor.", verse: "Salmos 28:7", workoutKey: "domingo_inferiores_a" },
                1: { activity: "MUSCULA√á√ÉO E CORRIDA", msg: "Construa sua for√ßa de cima para baixo. Foco e execu√ß√£o!", verse: "Filipenses 4:13", workoutKey: "segunda_costas_antebraco_biceps", runKey: "segunda_eloisa" }, 
                2: { activity: "DESCANSO ATIVO", msg: "Dia de descanso ativo. Uma caminhada leve pode ajudar na recupera√ß√£o.", verse: "Mateus 11:28" },
                3: { activity: "MUSCULA√á√ÉO E CORRIDA", msg: "Postura e for√ßa para seus ombros! Mantenha a forma.", verse: "Prov√©rbios 21:5", workoutKey: "quarta_inferiores_b", runKey: "quarta_eloisa" }, 
                4: { activity: "DESCANSO ATIVO", msg: "Descanse bem, reflita sobre seu progresso e agrade√ßa.", verse: "1 Pedro 5:7" },
                5: { activity: "MUSCULA√á√ÉO: PEITO + TR√çCEPS", msg: "Core forte, costas poderosas. O centro do seu poder!", verse: "Prov√©rbios 14:23", workoutKey: "sexta_peito_triceps" },
                6: { activity: "CORRIDA E MUSCULA√á√ÉO", msg: "Resist√™ncia e estrat√©gia na sua corrida mais longa! Conquiste!", verse: "Hebreus 12:1", workoutKey: "sabado_ombros_trapezio", runKey: "sabado_eloisa" }
            },
            weeklySchedule: [ { day: "Domingo", schedule: [{time: "06:00-07:10", task: "üèãÔ∏è‚Äç‚ôÇÔ∏è MUSCULA√á√ÉO: TREINO INFERIORES A"}, {time: "09:00-11:20", task: "üôè ESCOLA B√çBLICA DOMINICAL"}, {time: "18:30-20:00", task: "üôè CULTO NA IGREJA"}] }, { day: "Segunda-feira", schedule: [{time: "05:20-06:30", task: "ü¶æ MUSCULA√á√ÉO: COSTAS + ANTEBRA√áO + B√çCEPS"}, {time: "18:10-19:00", task: "üèÉ‚Äç‚ôÇÔ∏è CORRida LEVE (Ampaulo) / üèÉ‚Äç‚ôÄÔ∏è TREINO DE CORRIDA (Elo√≠sa)"}, {time: "21:00-22:00", "task": "üìö ESTUDO"}] }, { day: "Ter√ßa-feira", schedule: [{time: "20:00-20:45", task: "üôè CULTO EM FAM√çLIA EM NOSSA CASA"}] }, { day: "Quarta-feira", schedule: [{time: "05:20-06:30", task: "üí™ MUSCULA√á√ÉO: TREINO INFERIORES B"}, {time: "18:10-19:00", task: "üèÉ‚Äç‚ôÇÔ∏è CORRIDA INTERVALADA (Ampaulo) / üèÉ‚Äç‚ôÄÔ∏è TREINO DE CORRIDA (Elo√≠sa)"}, {time: "21:00-22:00", "task": "üìö ESTUDO"}] }, { day: "Quinta-feira", schedule: [{time: "19:30-21:00", task: "üôè CULTO PG ATALAIA"}] }, { day: "Sexta-feira", schedule: [{time: "05:20-06:30", task: "üèãÔ∏è‚Äç‚ôÇÔ∏è MUSCULA√á√ÉO: PEITO + TR√çCEPS"}, {time: "21:00-22:00", "task": "üìö ESTUDO"}] }, { day: "S√°bado", schedule: [{time: "05:20-06:30", task: "üèÉ‚Äç‚ôÇÔ∏è CORRIDA LONGA (Ampaulo) / üèÉ‚Äç‚ôÄÔ∏è TREINO DE CORRIDA (Elo√≠sa)"}, {time: "07:10-08:10", task: "üí™ MUSCULA√á√ÉO: OMBROS + TRAP√âZIO"}, {time: "14:20-17:00", task: "üë®‚Äçüë©‚Äçüë¶ AULAS DOS FILHOS"}] } ],
            finances: { billPayments: [ { name: "Vencimento Fatura Energia (Coelba)", day: 3 }, { name: "Vencimento Fatura Cart√£o Inter", day: 7 }, { name: "Vencimento Cons√≥rcio Biz (Honda)", day: 10 }, { name: "Vencimento Cons√≥rcio Biz (Honda)", day: 10 }, { name: "Vencimento Fatura Cart√£o C6Bank", day: 20 }, { name: "Vencimento Fatura Internet (Netcenter)", day: 20 }, { name: "Vencimento Fatura PicPay", day: 25 }, { name: "Vencimento Fatura √Ågua (Embasa)", day: 30 } ].sort((a, b) => a.day - b.day), creditCardInfo: [ { name: "Cart√£o Inter", closingDay: 30, maturityDay: 7 }, { name: "Cart√£o C6Bank", closingDay: 10, maturityDay: 20 }, { name: "Cart√£o PicPay", closingDay: 15, maturityDay: 25 } ].sort((a, b) => a.maturityDay - b.maturityDay), salaryDetails: { salaryDay: 5, advanceDay: 20 } }
        };

        // --- Firebase Variables (for Canvas use, injected in real environment) ---
        let app, db, auth, userId;
        const firebaseConfig = {
            apiKey: "AIzaSyDfw0hfPcfsZeIqQprzzRjUTpKvZ-dc_io", // Use your real key here in the local file
            authDomain: "painel-ampaulo.firebaseapp.com",
            projectId: "painel-ampaulo",
            storageBucket: "painel-ampaulo.firebasestorage.app",
            messagingSenderId: "1039977013900",
            appId: "1:1039977013900:web:a9e8387dc74ff7662b91a9",
            measurementId: "G-3QSW926GR7"
        };
        
        // User profile and progress data (loaded/saved in Firestore)
        window.userProfile = { name: "Convidado", gender: "nao-informar", dob: "1990-01-01", height: 0, currentWeight: 0, idealWeight: 0, email: "", phone: "" };

        // --- Firebase Functions ---
        async function initializeFirebaseAndAuth() {
            try {
                // Find the appId injected by the environment or use a default
                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                // Initialize Firebase with the provided config
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Try to authenticate with a custom token (if available) or anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInAnonymously(auth); // Using signInAnonymously as fallback
                } else {
                    await signInAnonymously(auth);
                }

                // Observe auth state to load data
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Load profile and progress data from Firestore
                        await loadUserProfileFromFirestore(currentAppId, userId);
                        await loadProgressDataFromFirestore(currentAppId, userId);
                    }
                    // Dispatch event when authentication and initial loading are ready
                    document.dispatchEvent(new Event('firebaseAuthReady'));
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.dispatchEvent(new Event('firebaseAuthReady'));
            }
        }

        async function saveUserProfileToFirestore(currentAppId, uid) {
            if (!uid || !db) return;
            const userDocRef = doc(db, `artifacts/${currentAppId}/users/${uid}/profile`, 'user-data');
            await setDoc(userDocRef, window.userProfile, { merge: true });
            console.log("User profile saved to Firestore.");
        };

        function loadUserProfileFromFirestore(currentAppId, uid) {
            return new Promise(resolve => {
                if (!uid || !db) { resolve(); return; }
                const userDocRef = doc(db, `artifacts/${currentAppId}/users/${uid}/profile`, 'user-data');
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        Object.assign(window.userProfile, docSnap.data());
                        console.log("User profile loaded from Firestore.");
                    } else {
                        console.log("No user profile found in Firestore.");
                    }
                    resolve();
                }, (error) => {
                    console.error("Error loading profile from Firestore:", error);
                    resolve();
                });
            });
        };

        async function saveProgressDataToFirestore(currentAppId, uid) {
            if (!uid || !db) return;
            const progressDocRef = doc(db, `artifacts/${currentAppId}/users/${uid}/progress`, 'progress-data');
            // Store the progress object as a JSON string in Firestore
            await setDoc(progressDocRef, { data: JSON.stringify(projectData.progress) }, { merge: true });
            console.log("Progress data saved to Firestore.");
        };

        function loadProgressDataFromFirestore(currentAppId, uid) {
            return new Promise(resolve => {
                if (!uid || !db) { resolve(); return; }
                const progressDocRef = doc(db, `artifacts/${currentAppId}/users/${uid}/progress`, 'progress-data');
                onSnapshot(progressDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().data) {
                        // Parse the JSON string back to an object
                        Object.assign(projectData.progress, JSON.parse(docSnap.data().data));
                        console.log("Progress data loaded from Firestore.");
                    } else {
                        console.log("No progress data found in Firestore.");
                    }
                    resolve();
                });
            });
        };


        // --- APPLICATION LOGIC ---
        const contentDiv = document.getElementById('app').querySelector('main');
        const navButtonsContainer = document.getElementById('main-nav');

        // Define Ampaulo's running schedule for August and subsequent months
        projectData.monthlyRunSchedules = {};

        const runCycle = [
            'ampaulo_intervalado',    // Treino 1
            'ampaulo_ritmo',          // Treino 2
            'ampaulo_progressivo',    // Treino 4
            'ampaulo_fartlek'         // Treino 5
        ];
        let runCycleIndex = 0; // Index for runCycle for Mondays and Wednesdays

        const startDate = new Date(2025, 7, 1); // August 1, 2025 (Month is 0-indexed)
        const endDate = new Date(2025, 11, 31); // December 31, 2025

        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const year = d.getFullYear();
            const month = d.getMonth();
            const dayOfMonth = d.getDate();
            const dayOfWeek = d.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const monthKey = `${year}-${month}`;

            if (!projectData.monthlyRunSchedules[monthKey]) {
                projectData.monthlyRunSchedules[monthKey] = {};
            }

            if (dayOfWeek === 6) { // Saturday
                projectData.monthlyRunSchedules[monthKey][dayOfMonth] = 'ampaulo_longao'; // Treino 3
            } else if (dayOfWeek === 1 || dayOfWeek === 3) { // Monday or Wednesday
                if (runCycleIndex >= runCycle.length) {
                    runCycleIndex = 0; // Reset cycle
                }
                projectData.monthlyRunSchedules[monthKey][dayOfMonth] = runCycle[runCycleIndex];
                runCycleIndex++;
            }
        }


        // New function to get the target distance for the Long Run for a specific month and year
        function getTargetLongaoDistanceForMonth(month, year) {
            const goal = projectData.progDistancia.goals.find(g => g.month === month && g.year === year);
            return goal ? goal.distance : projectData.virtualCoach.trainingTypes.longao.baseDistance;
        }

        // This function will now be responsible for generating and storing ALL scaled run plans
        function generateAndStoreScaledRunPlans() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-indexed

            const targetDistanceForCurrentMonth = getTargetLongaoDistanceForMonth(currentMonth, currentYear);
            const initialLongaoBaseDistance = projectData.virtualCoach.trainingTypes.longao.baseDistance;
            const scalingFactor = targetDistanceForCurrentMonth / initialLongaoBaseDistance;

            // Helper function to create the scaled run training object
            const createScaledRunObject = (originalType, keyPrefix, targetDistance, isLongao = false) => {
                let scaledStructure;
                let title;
                let objective;

                if (isLongao) {
                    scaledStructure = generateLongaoStructure(targetDistance);
                    title = `üèÉ‚Äç‚ôÇÔ∏è Corrida Longa (${getMonthName(today)} - Meta ${targetDistance}km)`;
                    objective = originalType.description;
                } else {
                    scaledStructure = scaleTrainingStructure(originalType, scalingFactor).structure;
                    title = `üèÉ‚Äç‚ôÇÔ∏è ${originalType.name.split(': ')[1]} (Escalada)`;
                    objective = originalType.description;
                }
                
                const totalDistance = scaledStructure.reduce((sum, phase) => {
                    const distValue = parseFloat(phase.distance);
                    return sum + (isNaN(distValue) ? 0 : distValue);
                }, 0);
                const totalTimeSeconds = scaledStructure.reduce((sum, phase) => {
                    const timeStr = calculateEstimatedTime(phase.distance, phase.zone);
                    const [min, sec] = timeStr.split(':').map(Number);
                    return sum + (min * 60) + sec;
                }, 0);
                const totalMinutes = Math.floor(totalTimeSeconds / 60);
                const totalSecondsRemainder = Math.round(totalTimeSeconds % 60);

                return {
                    key: `${keyPrefix}_${originalType.key || originalType.name.toLowerCase().replace(/[^a-z0-9]/g, '')}`,
                    title: title,
                    schedule: "Hor√°rio Adaptado", // Can be adapted according to training type
                    objective: objective,
                    estimated_distance: `~${totalDistance.toFixed(1)} km`,
                    total: { duration: `${totalMinutes} min ${totalSecondsRemainder.toString().padStart(2, '0')} sec`, distance: `${totalDistance.toFixed(1)} km` },
                    stages: scaledStructure.map(phase => ({
                        km: (typeof phase.distance === 'number')
                            ? (phase.distance === Math.floor(phase.distance) ? String(phase.distance) : phase.distance.toFixed(1))
                            : String(phase.phase), // Fallback for strings like "Aquecimento", "Desaquecimento"
                        name: phase.description,
                        pace: `${projectData.runs.paceDefinitionsAmpaulo.find(def => def.name.startsWith(phase.zone)).min_km}-${projectData.runs.paceDefinitionsAmpaulo.find(def => def.name.startsWith(phase.zone)).max_km}`,
                        zone: phase.zone,
                        estimated_time: calculateEstimatedTime(phase.distance, phase.zone)
                    }))
                };
            };

            // Generate and store all 5 Ampaulo training plans
            projectData.runs.ampaulo_intervalado = createScaledRunObject(projectData.virtualCoach.trainingTypes.intervalado, 'ampaulo');
            projectData.runs.ampaulo_ritmo = createScaledRunObject(projectData.virtualCoach.trainingTypes.ritmo, 'ampaulo');
            projectData.runs.ampaulo_longao = createScaledRunObject(projectData.virtualCoach.trainingTypes.longao, 'ampaulo', targetDistanceForCurrentMonth, true); // Long Run is special
            projectData.runs.ampaulo_progressivo = createScaledRunObject(projectData.virtualCoach.trainingTypes.progressivo, 'ampaulo');
            projectData.runs.ampaulo_fartlek = createScaledRunObject(projectData.virtualCoach.trainingTypes.fartlek, 'ampaulo');
        }

        // Function to scale training structure for a given scaling factor
        function scaleTrainingStructure(originalTrainingType, scalingFactor) {
            const scaledTraining = JSON.parse(JSON.stringify(originalTrainingType)); 

            if (scaledTraining.structure) {
                scaledTraining.structure.forEach(phase => {
                    if (typeof phase.distance === 'number') {
                        phase.distance = parseFloat((phase.distance * scalingFactor).toFixed(1)); 
                    }
                });
            }
            if (scaledTraining.estimated_distance && typeof scaledTraining.baseDistance === 'number') {
                const totalBaseDistance = scaledTraining.baseDistance;
                const newTotalDistance = parseFloat((totalBaseDistance * scalingFactor).toFixed(1));
                scaledTraining.estimated_distance = `~${newTotalDistance} km`;
                if (scaledTraining.total) {
                    scaledTraining.total.distance = `${newTotalDistance} km`;
                }
            }

            return scaledTraining;
        }


        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons(); 

            const views = document.querySelectorAll('.view');
            const navButtons = document.querySelectorAll('.nav-button');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    views.forEach(view => view.classList.toggle('active', view.id === targetId));

                    switch (targetId) {
                        case 'home':
                        case 'amanha':
                            initDynamicDayViews(); 
                            break;
                        case 'treino':
                            initWorkoutsView();
                            break;
                        case 'corrida':
                            initCorridaView();
                            break;
                        case 'prog-distancia':
                            initProgDistanciaView();
                            break;
                        case 'nutricao':
                            initNutritionView();
                            break;
                        case 'progresso':
                            initProgressView();
                            break;
                        case 'calendario':
                            initCalendarView();
                            break;
                        case 'financas':
                            initFinancesView();
                            break;
                    }
                });
            });

            document.addEventListener('firebaseAuthReady', () => {
                generateAndStoreScaledRunPlans(); // GENERATE and STORE scaled run plans for the current month
                generateWeeklyTrainingPlan(); // RENDER the weekly plan in the "Progress√£o" tab (which uses already scaled data)

                document.getElementById('home').classList.add('active');
                navButtonsContainer.querySelector('[data-target="home"]').classList.add('active');
                initDynamicDayViews(); 
            });

            const modal = document.getElementById('calendar-modal');
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.closest('#modal-close')) {
                    modal.classList.add('hidden');
                }
            });

            initializeFirebaseAndAuth();
        });


        // --- Functions to Populate Views ---

        function initDynamicDayViews() {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            populateDayView('home', today);
            populateDayView('amanha', tomorrow);
        }

        function populateDayView(viewId, date) {
            const container = document.getElementById(viewId);
            const dayOfMonth = date.getDate();
            const weekdayName = getDayName(date);
            const monthName = getMonthName(date);
            const weekdayIndex = date.getDay(); 
            const dayData = projectData.calendarActivities[weekdayIndex] || { msg: "Dia de descanso.", verse: "" };
            
            let scheduleHtml = '';
            const scheduleData = projectData.weeklySchedule.find(d => d.day === weekdayName + (weekdayIndex > 0 && weekdayIndex < 6 ? '-feira' : ''));
            if (scheduleData?.schedule.length > 0) {
                scheduleHtml = scheduleData.schedule.map(item => `<li class="flex items-center gap-4"><span class="bg-teal-100 text-teal-700 text-xs font-semibold px-2.5 py-0.5 rounded-full">${item.time}</span><span>${item.task}</span></li>`).join('');
            } else {
                scheduleHtml = '<li>Dia de descanso ou atividades flex√≠veis. Aproveite!</li>';
            }

            let workoutHtml = '';
            if (dayData.workoutKey) {
                const workout = projectData.workouts[dayData.workoutKey];
                workoutHtml = `<div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">üèãÔ∏è‚Äç‚ôÇÔ∏è Treino de Muscula√ß√£o</h3>
                    ${generateWorkoutHTML(workout, true)} 
                </div>`;
            }

            let runHtml = '';
            const dateKey = `${date.getFullYear()}-${date.getMonth()}`;
            const specificRunKey = projectData.monthlyRunSchedules[dateKey] ? projectData.monthlyRunSchedules[dateKey][dayOfMonth] : null;

            if (specificRunKey && projectData.runs[specificRunKey]) {
                const run = projectData.runs[specificRunKey];
                runHtml = `<div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">üèÉ‚Äç‚ôÇÔ∏è Treino de Corrida</h3>
                    ${generateRunHTML(run, true)}
                </div>`;
            } else if (dayData.runKey && projectData.runs[dayData.runKey]) { // Fallback for Eloisa or if no specific Ampaulo run is scheduled
                const run = projectData.runs[dayData.runKey];
                const isAmpauloRun = false; // This is now explicitly Eloisa or general
                runHtml = `<div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">üèÉ‚Äç‚ôÇÔ∏è Treino de Corrida</h3>
                    ${generateRunHTML(run, isAmpauloRun)}
                </div>`;
            }
            
            let financeHtml = '';
            const obligations = projectData.finances.billPayments.filter(b => b.day == dayOfMonth);
            if(obligations.length > 0) {
                financeHtml = `<div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">üí∞ Finan√ßas</h3>
                    <ul class="space-y-2 text-slate-600">${obligations.map(o => `<li class="flex items-center gap-2"><i data-lucide="alert-circle" class="text-red-500"></i>Vencimento: ${o.name}</li>`).join('')}</ul>
                </div>`
            }

            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-slate-800">${weekdayName}, ${dayOfMonth} de ${monthName}</h2>
                    <p class="text-slate-500 italic mt-1">"${dayData.msg}" - ${dayData.verse}</p>
                </div>
                <div class="mt-6 space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">üóìÔ∏è Sua Rotina</h3>
                        <ul class="space-y-3 text-slate-600">${scheduleHtml}</ul>
                    </div>
                    ${workoutHtml}
                    ${runHtml}
                    ${financeHtml}
                </div>`;
            lucide.createIcons(); 
        }

        function generateWorkoutHTML(workout, simpleCard = false) {
            if (!workout) return '';
            if (simpleCard) {
                return `<div>
                    <h4 class="text-lg font-bold text-slate-900">${workout.title}</h4>
                    <p class="text-sm text-slate-500 mt-1">${workout.objective}</p>
                    <div class="mt-4">
                        ${workout.groups.map(group => `
                            <div class="mb-2">
                                <h5 class="font-semibold text-md text-teal-700">${group.name} (${group.series} s√©ries)</h5>
                                <ul class="mt-1 pl-4 space-y-1 list-disc text-sm text-slate-600">
                                    ${group.exercises.map(ex => `<li><strong>${ex.name}:</strong> ${ex.sets}</li>`).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
            return `
                <button class="workout-accordion-button w-full text-left p-4 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-slate-900">${workout.title}</h3>
                        <p class="text-sm text-slate-500 mt-1">${workout.objective}</p>
                    </div>
                    <i data-lucide="chevron-down" class="transition-transform"></i>
                </button>
                <div class="workout-accordion-content px-4 pb-4">
                    <div class="border-t pt-4">
                        ${workout.groups.map(group => `
                            <div class="mb-4">
                                <h4 class="font-semibold text-md text-teal-700">${group.name} (${group.series} s√©ries)</h4>
                                <ul class="mt-2 pl-5 space-y-2 list-disc text-sm text-slate-600">
                                    ${group.exercises.map(ex => `<li><strong>${ex.name}:</strong> ${ex.sets}</li>`).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        // Generates HTML for a running training
        function generateRunHTML(run, isAmpaulo) {
            if (!run) return '';
            let stagesHtml = '';
            if (isAmpaulo) {
                stagesHtml = `
                    <thead><tr><th>Km</th><th>Etapa</th><th>Pace</th><th>Zona</th><th>Tempo</th></tr></thead>
                    <tbody>${run.stages.map(s => {
                        let kmDisplay = '';
                        if (s && s.km !== undefined && s.km !== null) {
                            if (typeof s.km === 'number') {
                                kmDisplay = s.km.toFixed(1);
                            } else if (typeof s.km === 'string' && !isNaN(parseFloat(s.km))) {
                                kmDisplay = parseFloat(s.km).toFixed(1);
                            } else {
                                kmDisplay = '-';
                            }
                        } else {
                            kmDisplay = '-';
                        }
                        return `<tr><td class="p-2">${kmDisplay}</td><td class="p-2">${s.name}</td><td class="p-2">${s.pace}</td><td class="p-2">${s.zone}</td><td class="p-2">${s.estimated_time}</td></tr>`;
                    }).join('')}</tbody>`;
            } else {
                stagesHtml = `
                    <thead><tr><th>Etapa</th><th>Dura√ß√£o</th><th>Ritmo</th></tr></thead>
                    <tbody>${run.stages.map(s => `<tr><td class="p-2">${s.name}</td><td class="p-2">${s.duration}</td><td class="p-2">${s.pace}</td></tr>`).join('')}</tbody>`;
            }

            return `<h4 class="text-lg font-bold text-slate-900">${run.title}</h4>
                    <div class="overflow-x-auto mt-4">
                        <table class="run-table w-full text-sm">
                            ${stagesHtml}
                        </table>
                    </div>
                    <div class="mt-4 pt-4 border-t flex justify-between font-semibold">
                        <span>Total:</span>
                        <span>${run.total.duration} / ~${run.total.distance}</span>
                    </div>`;
        }
        
        function getCurrentLongaoDistance() {
            const today = new Date();
            const currentMonth = today.getMonth(); 
            const currentYear = today.getFullYear();
            return getTargetLongaoDistanceForMonth(currentMonth, currentYear);
        }
        
        function updateCurrentWeek() {
            projectData.virtualCoach.currentWeek = projectData.virtualCoach.currentWeek === 1 ? 2 : 1;
            document.getElementById('week-selector').value = projectData.virtualCoach.currentWeek;
            updateWeekDisplay();
            generateAndStoreScaledRunPlans(); 
            generateWeeklyTrainingPlan(); 
        }
        
        function updateWeekDisplay() {
            // "Current Status" and "Settings" sections have been removed, so these elements no longer exist here.
            // Keeping the function for compatibility in case "currentWeek" logic is used elsewhere.
            // console.log("currentWeek:", projectData.virtualCoach.currentWeek);
            // console.log("nextLongaoDistance:", getCurrentLongaoDistance() + 'km');
        }
        
        function paceToSeconds(paceString) {
            const [minutes, seconds] = paceString.split(':').map(Number);
            return minutes * 60 + seconds;
        }
        
        function secondsToPace(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.round(totalSeconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function calculateEstimatedTime(distance, zoneName) {
            const paceDef = projectData.runs.paceDefinitionsAmpaulo.find(def => def.name.startsWith(zoneName));
            if (!paceDef) return "N/A";
            
            const avgPaceSeconds = (paceToSeconds(paceDef.min_km) + paceToSeconds(paceDef.max_km)) / 2;
            
            const totalTimeSeconds = distance * avgPaceSeconds;
            const minutes = Math.floor(totalTimeSeconds / 60);
            const seconds = Math.round(totalTimeSeconds % 60);
            
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function generateLongaoStructure(distance) {
            const structure = [
                { phase: "Aquecimento", distance: 1.0, zone: "Z1", description: "Prepara√ß√£o corporal" }
            ];

            const mainKm = distance - 2; 
            if (mainKm > 0) {
                for(let i=1; i <= mainKm; i++) {
                    const zone = i % 2 !== 0 ? "Z2" : "Z3";
                    structure.push({
                        phase: `Ritmo ${i}`,
                        distance: 1.0,
                        zone: zone,
                        description: zone === "Z2" ? "Ritmo confort√°vel" : "Ritmo moderado"
                    });
                }
            }
            
            structure.push({ phase: "Desaquecimento", distance: 1.0, zone: "Z1", description: "Volta √† calma" });
            return structure;
        }
        
        function generateWeeklyTrainingPlan() {
            const container = document.getElementById('weekly-training-plan');
            if (!container) return; 

            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            let planHtml = '';
            const daysToShow = 7; 

            for (let i = 0; i < daysToShow; i++) {
                const date = new Date(today);
                date.setDate(currentDay + i); 

                const dayName = getDayName(date);
                const monthName = getMonthName(date);
                const dayOfMonth = date.getDate();
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;

                let trainingDescription = 'Dia de descanso ou atividade flex√≠vel.';
                let trainingDetailsHtml = '';
                let trainingType = null;
                let isAmpauloRun = false;

                // Check for specific Ampaulo run in monthly schedule
                if (projectData.monthlyRunSchedules[monthKey] && projectData.monthlyRunSchedules[monthKey][dayOfMonth]) {
                    trainingType = projectData.monthlyRunSchedules[monthKey][dayOfMonth];
                    isAmpauloRun = true;
                } else {
                    // Fallback to general calendar activities for Eloisa or general non-ampaulo days
                    const weekdayIndex = date.getDay();
                    if (projectData.calendarActivities[weekdayIndex] && projectData.calendarActivities[weekdayIndex].runKey) {
                        trainingType = projectData.calendarActivities[weekdayIndex].runKey;
                        isAmpauloRun = false; // Eloisa run
                    }
                }

                let title = `${dayName}, ${dayOfMonth} de ${monthName}`;

                if (trainingType && projectData.runs[trainingType]) {
                    const run = projectData.runs[trainingType];
                    const totalDistance = parseFloat(run.total.distance.replace(' km', ''));
                    const totalDuration = run.total.duration;

                    title = `üèÉ‚Äç‚ôÇÔ∏è ${run.title.replace('üèÉ‚Äç‚ôÇÔ∏è ', '').split('(')[0].trim()} - ${title}`;
                    trainingDescription = run.objective || run.title; // Use objective if available, else title

                    if (isAmpauloRun) {
                        trainingDetailsHtml = `
                            <div class="bg-slate-50 p-4 rounded-lg mt-4">
                                <h4 class="font-bold mb-3">üìã Plano Detalhado:</h4>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-xs border border-slate-300">
                                        <thead class="bg-slate-800 text-white">
                                            <tr>
                                                <th class="border border-slate-300 px-2 py-1">Km</th><th class="border border-slate-300 px-2 py-1">Etapa</th><th class="border border-slate-300 px-2 py-1">Pace</th><th class="border border-slate-300 px-2 py-1">Zona</th><th class="border border-slate-300 px-2 py-1">Tempo Est.</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${run.stages.map((stage, index) => {
                                                let paceRange = "N/A";
                                                let zoneDisplay = "";
                                                const paceDef = projectData.runs.paceDefinitionsAmpaulo.find(def => def.name.startsWith(stage.zone));
                                                if (paceDef) {
                                                    paceRange = `${paceDef.min_km}-${paceDef.max_km}`;
                                                    zoneDisplay = `<span class="bg-slate-200 px-1 rounded text-xs">${stage.zone}</span>`;
                                                }

                                                let kmDisplay = (typeof stage.km === 'number') ? stage.km.toFixed(1) : String(stage.km);

                                                return `<tr class="border-b border-slate-200 ${index % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                                                    <td class="border border-slate-300 px-2 py-1 font-medium">${kmDisplay}</td>
                                                    <td class="border border-slate-300 px-2 py-1">${stage.name}</td>
                                                    <td class="border border-slate-300 px-2 py-1">${paceRange}</td>
                                                    <td class="border border-slate-300 px-2 py-1">${zoneDisplay}</td>
                                                    <td class="border border-slate-300 px-2 py-1">${stage.estimated_time}</td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 p-3 bg-slate-100 rounded border">
                                    <p class="font-bold text-slate-800">üìä Resumo Total:</p>
                                    <p class="text-slate-700">Dist√¢ncia: <strong>${totalDistance.toFixed(1)}km</strong> | Tempo Estimado: <strong>${totalDuration}</strong></p>
                                </div>
                            </div>`;
                    } else { // Eloisa run
                         trainingDetailsHtml = `
                            <div class="bg-slate-50 p-4 rounded-lg mt-4">
                                <h4 class="font-bold mb-3">üìã Plano Detalhado:</h4>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-xs border border-slate-300">
                                        <thead class="bg-slate-800 text-white">
                                            <tr>
                                                <th class="border border-slate-300 px-2 py-1">Etapa</th><th class="border border-slate-300 px-2 py-1">Dura√ß√£o</th><th class="border border-slate-300 px-2 py-1">Ritmo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${run.stages.map((stage, index) => `<tr class="border-b border-slate-200 ${index % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">
                                                <td class="border border-slate-300 px-2 py-1">${stage.name}</td>
                                                <td class="border border-slate-300 px-2 py-1">${stage.duration}</td>
                                                <td class="border border-slate-300 px-2 py-1">${stage.pace}</td>
                                            </tr>`).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 p-3 bg-slate-100 rounded border">
                                    <p class="font-bold text-slate-800">üìä Resumo Total:</p>
                                    <p class="text-slate-700">Dura√ß√£o: <strong>${run.total.duration}</strong></p>
                                </div>
                            </div>`;
                    }
                }

                planHtml += `
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-teal-500">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-slate-900">${title}</h3>
                                <p class="text-slate-600">${trainingDescription}</p>
                            </div>
                            ${trainingType ? `<div class="text-right mt-2 md:mt-0">
                                <p class="text-lg font-bold text-slate-800">${isAmpauloRun ? totalDistance.toFixed(1) + 'km' : totalDuration}</p>
                                <p class="text-sm text-slate-600">Estimado</p>
                            </div>` : ''}
                        </div>
                        ${trainingDetailsHtml}
                    </div>`;
            }
            container.innerHTML = planHtml;
            const lastGeneratedEl = document.getElementById('last-generated');
            if(lastGeneratedEl) lastGeneratedEl.textContent = today.toLocaleDateString('pt-BR');
            lucide.createIcons();
        }

        // --- View Initialization Functions ---
        function initWorkoutsView() {
            const container = document.getElementById('treino');
            const workoutOrder = ['segunda_costas_antebraco_biceps', 'quarta_inferiores_b', 'sexta_peito_triceps', 'sabado_ombros_trapezio', 'domingo_inferiores_a'];
            let html = `<h2 class="text-2xl font-bold text-slate-800 mb-4">Plano de Treino</h2><div class="space-y-4">`;
            
            workoutOrder.forEach(key => {
                const workout = projectData.workouts[key];
                html += `<div class="bg-white rounded-lg shadow-md">${generateWorkoutHTML(workout)}</div>`; 
            });
            html += '</div>';
            container.innerHTML = html;
            lucide.createIcons();

            container.querySelectorAll('.workout-accordion-button').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('i');
                    button.classList.toggle('open');
                    icon.classList.toggle('rotate-180');
                    if (button.classList.contains('open')) {
                        content.style.maxHeight = content.scrollHeight + "px";
                    } else {
                        content.style.maxHeight = null;
                    }
                });
            });
        }
        
        function initCorridaView() {
            const container = document.getElementById('corrida');
            container.innerHTML = `<h2 class="text-2xl font-bold text-slate-800 mb-4">Plano de Corrida</h2>
                <div class="bg-white rounded-lg shadow-md p-2 mb-6">
                    <div class="flex justify-center items-center gap-2" id="corrida-sub-nav">
                        <button data-target="corrida-ampaulo" class="sub-nav-button active flex-1 text-center font-semibold py-2 px-4 rounded-lg">Treino Ampaulo</button>
                        <button data-target="corrida-eloisa" class="sub-nav-button flex-1 text-center font-semibold py-2 px-4 rounded-lg">Treino Elo√≠sa</button>
                    </div>
                </div>
                <div id="corrida-ampaulo" class="run-content-section active"></div>
                <div id="corrida-eloisa" class="run-content-section"></div>`;

            const ampauloContainer = document.getElementById('corrida-ampaulo');
            const eloisaContainer = document.getElementById('corrida-eloisa');
            
            // Pass the new keys of the scaled Ampaulo training
            ampauloContainer.innerHTML = generateRunSectionHTML(
                ['ampaulo_intervalado', 'ampaulo_ritmo', 'ampaulo_longao', 'ampaulo_progressivo', 'ampaulo_fartlek'], 
                projectData.runs.paceDefinitionsAmpaulo, true
            );
            eloisaContainer.innerHTML = generateRunSectionHTML(['segunda_eloisa', 'quarta_eloisa', 'sabado_eloisa'], projectData.runs.paceDefinitionsEloisa, false);
            lucide.createIcons();

            container.querySelectorAll('.sub-nav-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    container.querySelectorAll('.sub-nav-button').forEach(btn => btn.classList.remove('active'));
                    container.querySelectorAll('.run-content-section').forEach(section => section.classList.remove('active'));
                    
                    e.currentTarget.classList.add('active');
                    const targetElement = container.querySelector(`#${e.currentTarget.dataset.target}`);
                    if (targetElement) {
                        targetElement.classList.add('active');
                    }
                });
            });
        }

        function generateRunSectionHTML(runKeys, paceDefs, isAmpaulo) {
            let html = `
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-bold text-slate-900 mb-4">Defini√ß√µes de Ritmo (Pace Zones)</h3>
                    <div class="overflow-x-auto"><table class="run-table w-full text-sm text-left border-collapse"><thead><tr>
                        <th class="px-4 py-2">Zona</th><th class="px-4 py-2">Min/Km</th><th class="px-4 py-2">Max/Km</th><th class="px-4 py-2">Descri√ß√£o</th>
                    </tr></thead><tbody>
                    ${paceDefs.map(zone => `<tr><td class="px-4 py-2"><strong>${zone.name}</strong></td><td>${zone.min_km}</td><td>${zone.max_km}</td><td>${zone.description}</td></tr>`).join('')}
                    </tbody></table></div>
                </div>
                <div class="space-y-8">
                    ${runKeys.map(key => {
                        const run = projectData.runs[key];
                        if (!run) return '';
                        return `
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            ${generateRunHTML(run, isAmpaulo)}
                        </div>`;
                    }).join('')}
                </div>`;
            return html;
        }

        function initProgDistanciaView() {
            const container = document.getElementById('prog-distancia');
            const data = projectData.progDistancia;
            const today = new Date();
            const currentMonth = today.getMonth(); 
            const currentYear = today.getFullYear();
            
            // Removed "ü§ñ Virtual Running Coach" and "‚öôÔ∏è Settings" from here
            // Removed "üìã Current Pace Zones" from here

            const goalsHtml = `
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold text-teal-700 mb-2 text-center">${data.title}</h2>
                    <p class="text-slate-600 mb-8 text-center max-w-3xl mx-auto">${data.description}</p>
                    <div id="month-goal-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${data.goals.map(goal => {
                            const targetDate = getLastSaturday(goal.year, goal.month -1); // Adjust month to be 0-indexed for Date object
                            const isCurrentMonth = goal.month === currentMonth +1 && goal.year === currentYear; // Adjust month for comparison
                            return `
                            <div class="goal-card ${isCurrentMonth ? 'current-month' : ''} bg-slate-50 p-6 rounded-lg text-center cursor-pointer transition-transform hover:scale-105"
                                 data-month="${goal.month}" data-year="${goal.year}" data-distance="${goal.distance}" data-label="${goal.label}">
                                <h3 class="text-2xl font-bold text-teal-800">${goal.label.toUpperCase()} ${goal.year}</h3>
                                <p class="text-5xl font-bold text-green-600 my-3">${goal.distance}<span class="text-2xl font-medium">km</span></p>
                                <p class="text-slate-600 font-semibold">Corrida Alvo: ${targetDate.toLocaleDateString('pt-BR')}</p>
                            </div>`;
                        }).join('')}
                    </div>
                    <div id="goal-calendar-container" class="mt-12"></div>
                </div>`;

            container.innerHTML = goalsHtml + `<div id="weekly-training-plan" class="space-y-6 mt-6"></div>`; // Move weekly-training-plan to be after goals
            
            // Removed event listeners for 'generate-weekly-plan-btn', 'update-week-btn', and 'week-selector'
            // because the associated elements have been removed.
            
            // Added logic to manage the 'current-month' class on clicks
            container.querySelectorAll('.goal-card').forEach(card => card.addEventListener('click', e => {
                // Remove 'current-month' from all cards first
                document.querySelectorAll('.goal-card').forEach(c => c.classList.remove('current-month'));
                // Add 'current-month' only to the clicked card
                e.currentTarget.classList.add('current-month');

                const { month, year, distance, label } = e.currentTarget.dataset;
                showGoalMonthCalendar(parseInt(month), parseInt(year), parseInt(distance), label);
            }));

            // This listener is for calendar days within the "Progress√£o" tab
            container.addEventListener('click', e => {
                const runDayCard = e.target.closest('.run-day');
                const activityDayCard = e.target.closest('.calendar-day-with-activity'); // For other activities
                if (runDayCard || activityDayCard) {
                    showActivityModal(e.target.closest('button')); // Pass the clicked button element
                }
            });
            lucide.createIcons();
            // Call generateWeeklyTrainingPlan here to ensure the section is populated when the tab is opened
            generateWeeklyTrainingPlan();
        }

        // Displays the calendar for a goal month
        function showGoalMonthCalendar(month, year, distance, label) {
            const container = document.getElementById('goal-calendar-container');
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 = Sunday, 6 = Saturday
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // Last day of the month

            let calendarHtml = `<div class="bg-slate-50 p-6 rounded-lg shadow-inner border animate-fadeIn">
                <h3 class="text-2xl font-bold text-center text-slate-800 mb-6">Plano de Corrida: ${label} ${year}</h3>
                <div class="grid grid-cols-7 gap-2 text-center font-semibold text-slate-600 mb-2">
                    ${["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"].map(d => `<div>${d}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7 gap-2">`;
            
            // Add empty divs to fill days before the 1st of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarHtml += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const weekdayIndex = date.getDay(); // Day of the week (0=Sun, 6=Sat)
                const today = new Date();
                const isToday = today.getFullYear() === year && today.getMonth() === month && day === today.getDate();

                let dayClass = isToday ? 'bg-teal-500 text-white' : 'bg-slate-100';
                let trainingInfo = '', dataAttributes = '';

                const dateKey = `${year}-${month}`;
                let specificRunKey = null; // Key for Ampaulo runs from monthly schedule
                let generalActivity = projectData.calendarActivities[weekdayIndex] || null; // General activity for the weekday

                // 1. Check for specific Ampaulo run
                if (projectData.monthlyRunSchedules[dateKey] && projectData.monthlyRunSchedules[dateKey][day]) {
                    specificRunKey = projectData.monthlyRunSchedules[dateKey][day];
                }

                if (specificRunKey) { // It's an Ampaulo run
                    const targetDistanceForSelectedMonth = getTargetLongaoDistanceForMonth(month, year);
                    const initialLongaoBaseDistance = projectData.virtualCoach.trainingTypes.longao.baseDistance;
                    const scalingFactorForSelectedMonth = targetDistanceForSelectedMonth / initialLongaoBaseDistance;

                    const originalType = projectData.virtualCoach.trainingTypes[specificRunKey.replace('ampaulo_', '')];
                    let runForCalendarDisplay;

                    if (specificRunKey === 'ampaulo_longao') {
                        const longRunScaledStructure = generateLongaoStructure(targetDistanceForSelectedMonth);
                        const longRunTotalDistance = longRunScaledStructure.reduce((sum, phase) => sum + phase.distance, 0);
                        runForCalendarDisplay = {
                            title: `üèÉ‚Äç‚ôÇÔ∏è Corrida Longa`, 
                            total: { distance: `${longRunTotalDistance.toFixed(1)} km` }
                        };
                    } else {
                        const scaledTraining = scaleTrainingStructure(originalType, scalingFactorForSelectedMonth);
                        const totalDistance = scaledTraining.structure.reduce((sum, phase) => sum + phase.distance, 0);
                        runForCalendarDisplay = {
                            title: `üèÉ‚Äç‚ôÇÔ∏è ${originalType.name.split(': ')[1].replace('Treino ', '').trim()}`, 
                            total: { distance: `${totalDistance.toFixed(1)} km` }
                        };
                    }
                    
                    dayClass = 'bg-green-100 border border-green-200 run-day cursor-pointer hover:bg-green-200';
                    dataAttributes = `data-run-key="${specificRunKey}" data-day="${day}" data-month="${month}" data-year="${year}"`;
                    
                    let displayedDistance = '';
                    if (runForCalendarDisplay.total && runForCalendarDisplay.total.distance) {
                         displayedDistance = `<span class="text-xs text-teal-600 block font-bold">Meta: ${runForCalendarDisplay.total.distance}</span>`;
                    }
                    let displayName = runForCalendarDisplay.title.replace('üèÉ‚Äç‚ôÇÔ∏è', '').replace('Corrida', '').replace(/\(.+\)/, '').trim();
                    trainingInfo = `<span class="text-xs text-green-800 font-semibold mt-1 block">${displayName}</span> ${displayedDistance}`;
                } else if (generalActivity) { // It's a general activity (muscula√ß√£o, Eloisa's run, or rest)
                    let activityLabel = generalActivity.activity;
                    let activityIcon = '';
                    let runOrWorkoutKey = '';

                    if (generalActivity.workoutKey && !generalActivity.runKey) {
                        activityIcon = 'üèãÔ∏è‚Äç‚ôÇÔ∏è ';
                        runOrWorkoutKey = generalActivity.workoutKey;
                        dataAttributes = `data-workout-key="${runOrWorkoutKey}" data-day="${day}" data-month="${month}" data-year="${year}"`;
                    } else if (generalActivity.runKey) {
                        activityIcon = 'üèÉ‚Äç‚ôÄÔ∏è '; // Assuming Eloisa's run
                        runOrWorkoutKey = generalActivity.runKey;
                        dataAttributes = `data-run-key="${runOrWorkoutKey}" data-day="${day}" data-month="${month}" data-year="${year}"`;
                    } else {
                        activityIcon = 'üßò '; // Default for rest/active rest
                        dataAttributes = `data-day="${day}" data-month="${month}" data-year="${year}"`; // For general modal
                    }

                    // Shorten the activity label if too long for calendar cell
                    if (activityLabel.includes("MUSCULA√á√ÉO")) {
                        activityLabel = "Muscula√ß√£o";
                    } else if (activityLabel.includes("CORRIDA E MUSCULA√á√ÉO")) {
                        activityLabel = "Corrida/Musc.";
                    } else if (activityLabel.includes("DESCANSO")) {
                        activityLabel = "Descanso";
                    }

                    trainingInfo = `<span class="text-xs text-slate-700 font-semibold mt-1 block">${activityIcon}${activityLabel}</span>`;
                    dayClass = 'bg-blue-100 border border-blue-200 calendar-day-with-activity cursor-pointer hover:bg-blue-200';
                }


                calendarHtml += `<button data-day="${day}" data-month="${month}" data-year="${year}" ${dataAttributes} class="calendar-day-btn h-10 flex items-center justify-center rounded-full ${dayClass} hover:bg-teal-200 transition-colors">${day}${trainingInfo}</button>`;
            }
            container.innerHTML = calendarHtml + '</div></div>';
            container.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
            lucide.createIcons(); 
        }

        function initNutritionView() {
            const container = document.getElementById('nutricao');
            const data = projectData.nutrition;
            const foodIcons = {
                "Ovo de galinha": "ü•ö", "Cuscuz de milho cozido": "üåΩ", "Mel√£o": "üçà", "Caf√© coado (suave)": "‚òï",
                "Arroz branco ou integral": "üçö", "Feij√£o carioca/preto": "üç≤", "Legumes e vegetais ao vapor": "ü•¶",
                "Salada colorida sem fruta": "ü•ó", "Peito de frango sem pele cozido": "üçó", "Peito de frango ou carne magra": "ü•©"
            };
            container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-2xl font-bold text-teal-700 text-center">Plano Alimentar</h2>
                <p class="text-center text-slate-500 mb-4">por <strong>${data.professional}</strong></p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${data.meals.map(meal => `
                    <div class="bg-slate-50 p-4 rounded-lg border">
                        <h3 class="font-bold text-lg">${meal.time} - ${meal.name}</h3>
                        <ul class="mt-2 space-y-2 text-sm">${meal.items.map(food => {
                            let subsHtml = '';
                            if (food.substitutes) {
                                const substitutesList = food.substitutes.split(',').map(s => `<li>${s.trim()}</li>`).join('');
                                subsHtml = `<br><em class="text-xs text-slate-500">Substitui√ß√µes:</em><ul class="list-disc list-inside text-xs text-slate-500 ml-4">${substitutesList}</ul>`;
                            }
                            return `<li><span class="text-2xl">${food.icon || foodIcons[food.item] || '‚ùì'}</span> <span class="font-semibold">${food.item}:</span> ${food.amount}${subsHtml}</li>`;
                        }).join('')}
                        </ul>
                    </div>`).join('')}
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-bold mb-4">üíß Minha Meta de Hidrata√ß√£o Semanal</h3>
                <ul class="list-disc list-inside space-y-2 text-slate-600">
                    <li>Segunda a Quinta: <strong>4 litros</strong> por dia</li>
                    <li>Sexta: <strong>3 litros</strong></li>
                    <li>S√°bado: <strong>2 litros</strong></li>
                    <li>Domingo: <strong>1 litro</strong></li>
                </ul>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4">Informa√ß√µes Gerais</h3>
                <ul class="list-disc list-inside space-y-2 text-slate-600">${data.generalInfo.map(info => `<li>${info}</li>`).join('')}</ul>
            </div>`;
            lucide.createIcons(); 
        }

        function renderRunningGoalsTable() {
            const goals = projectData.progDistancia.goals;
            let html = `
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-bold text-center mb-4">Metas de Progress√£o de Corrida</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-800 text-white">
                                <tr>
                                    <th class="p-2">M√™s/Ano</th>
                                    <th class="p-2">Dist√¢ncia Alvo (km)</th>
                                    <th class="p-2">Corrida Alvo</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${goals.map(goal => {
                                    const targetDate = getLastSaturday(goal.year, goal.month - 1); // Adjust month to be 0-indexed
                                    return `
                                        <tr class="border-b odd:bg-slate-50">
                                            <td class="p-2">${goal.label} ${goal.year}</td>
                                            <td class="p-2">${goal.distance}</td>
                                            <td class="p-2">${targetDate.toLocaleDateString('pt-BR')}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return html;
        }

        function initProgressView() {
            const container = document.getElementById('progresso');
            container.innerHTML = `
                <h2 class="text-3xl font-bold text-slate-800 mb-4">Acompanhamento do Progresso</h2>
                ${renderRunningGoalsTable()} <!-- New section for running goals -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold text-center mb-4">Medidas Corporais</h3>
                    <div class="overflow-x-auto"><table id="progress-table" class="w-full text-sm text-left">
                        <thead class="bg-slate-800 text-white"><tr>
                            <th class="p-2">Data</th><th>Peso (kg)</th><th>% Gordura</th><th>M. Gorda (kg)</th><th>M. Magra (kg)</th><th>Cintura (cm)</th><th>Abd√¥men (cm)</th>
                        </tr></thead><tbody></tbody>
                    </table></div>
                    <div class="text-center mt-6"><button id="generate-charts-btn" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg">Gerar Gr√°ficos de Medidas</button></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-center mb-4">Peso e % de Gordura</h3><div class="chart-container"><canvas id="weightFatChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-center mb-4">Composi√ß√£o Corporal</h3><div class="chart-container"><canvas id="bodyCompositionChart"></canvas></div></div>
                </div>`;
            renderProgressTable();
            document.getElementById('generate-charts-btn').addEventListener('click', initCharts);
            lucide.createIcons();
        }

        function renderProgressTable() {
            const tableBody = document.getElementById('progress-table')?.querySelector('tbody');
            if(!tableBody) return;
            tableBody.innerHTML = projectData.progress.dates.map((date, i) => `
                <tr class="border-b odd:bg-slate-50">
                    <td class="p-2">${date}</td><td>${projectData.progress.weight[i]}</td><td>${projectData.progress.fatPercentage[i]}</td>
                    <td>${projectData.progress.fatMass[i]}</td><td>${projectData.progress.leanMass[i]}</td>
                    <td>${projectData.progress.waist[i]}</td><td>${projectData.progress.abdomen[i]}</td>
                </tr>`).join('');
        }

        function initCharts() {
            if (window.weightFatChartInstance) window.weightFatChartInstance.destroy();
            if (window.bodyCompositionChartInstance) window.bodyCompositionChartInstance.destroy();
            
            const pData = projectData.progress;
            const commonOptions = { responsive: true, maintainAspectRatio: false };
            
            const weightCtx = document.getElementById('weightFatChart');
            if (weightCtx) {
                window.weightFatChartInstance = new Chart(weightCtx.getContext('2d'), { 
                    type: 'line', 
                    data: { 
                        labels: pData.dates, 
                        datasets: [
                            { label: 'Peso (kg)', data: pData.weight, borderColor: '#0d9488', yAxisID: 'y', fill: false, tension: 0.1 }, 
                            { label: '% de Gordura', data: pData.fatPercentage, borderColor: '#f97316', yAxisID: 'y1', fill: false, tension: 0.1 }
                        ] 
                    }, 
                    options: { 
                        ...commonOptions, 
                        scales: { 
                            y: { position: 'left', beginAtZero: false }, 
                            y1: { position: 'right', grid: { drawOnChartArea: false }, beginAtZero: false } 
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    } 
                });
                weightCtx.setAttribute('__chartjs__', 'true'); 
            }

            const compCtx = document.getElementById('bodyCompositionChart');
            if (compCtx) {
                window.bodyCompositionChartInstance = new Chart(compCtx.getContext('2d'), { 
                    type: 'bar', 
                    data: { 
                        labels: pData.dates, 
                        datasets: [
                            { label: 'Massa Gorda (kg)', data: pData.fatMass, backgroundColor: '#f97316' }, 
                            { label: 'Massa Magra (kg)', data: pData.leanMass, backgroundColor: '#0d9488' }
                        ] 
                    }, 
                    options: { 
                        ...commonOptions, 
                        scales: { 
                            x: { stacked: true }, 
                            y: { stacked: true, beginAtZero: true } 
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    } 
                });
                compCtx.setAttribute('__chartjs__', 'true');
            }
        }

        function initCalendarView() {
            const container = document.getElementById('calendario');
            const today = new Date();
            let html = `<h2 class="text-2xl font-bold text-slate-800 mb-4">Calend√°rio</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">`;
            
            // Loop to generate calendars for the next months (starting from the current month)
            for (let i = 0; i < (12 - today.getMonth()); i++) { 
                const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                html += generateMonthCalendar(date.getFullYear(), date.getMonth());
            }

            html += '</div>';
            container.innerHTML = html;

            // Add event listener for calendar buttons
            container.querySelectorAll('.calendar-day-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    showActivityModal(e.currentTarget); // Pass the clicked button element
                })
            })
            lucide.createIcons(); 
        }

        function generateMonthCalendar(year, month) {
            const monthName = getMonthName(new Date(year, month));
            const firstDay = new Date(year, month, 1).getDay(); // 0 = Sunday, 6 = Saturday
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // Last day of the month

            let calendarHtml = `<div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-2xl font-bold text-center text-slate-800 mb-6">${monthName} ${year}</h3>
                <div class="grid grid-cols-7 gap-2 text-center font-semibold text-slate-600 mb-2">
                    ${["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"].map(d => `<div>${d}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7 gap-2">`;
            
            // Add empty divs to fill days before the 1st of the month
            for (let i = 0; i < firstDay; i++) {
                calendarHtml += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const weekdayIndex = date.getDay(); // Day of the week (0=Sun, 6=Sat)
                const today = new Date();
                const isToday = today.getFullYear() === year && today.getMonth() === month && day === today.getDate();

                let dayClass = isToday ? 'bg-teal-500 text-white' : 'bg-slate-100';
                let activityInfo = '', dataAttributes = '';

                const dateKey = `${year}-${month}`;
                let specificAmpauloRunKey = null; // Key for Ampaulo runs from monthly schedule
                let generalActivity = projectData.calendarActivities[weekdayIndex] || null; // General activity for the weekday

                // 1. Check for specific Ampaulo run from the generated monthly schedule
                if (projectData.monthlyRunSchedules[dateKey] && projectData.monthlyRunSchedules[dateKey][day]) {
                    specificAmpauloRunKey = projectData.monthlyRunSchedules[dateKey][day];
                }

                if (specificAmpauloRunKey) { // It's an Ampaulo run
                    const targetDistanceForSelectedMonth = getTargetLongaoDistanceForMonth(month, year);
                    const initialLongaoBaseDistance = projectData.virtualCoach.trainingTypes.longao.baseDistance;
                    const scalingFactorForSelectedMonth = targetDistanceForSelectedMonth / initialLongaoBaseDistance;

                    const originalType = projectData.virtualCoach.trainingTypes[specificAmpauloRunKey.replace('ampaulo_', '')];
                    let runForCalendarDisplay;

                    if (specificAmpauloRunKey === 'ampaulo_longao') {
                        const longRunScaledStructure = generateLongaoStructure(targetDistanceForSelectedMonth);
                        const longRunTotalDistance = longRunScaledStructure.reduce((sum, phase) => sum + phase.distance, 0);
                        runForCalendarDisplay = {
                            title: `üèÉ‚Äç‚ôÇÔ∏è Corrida Longa`, 
                            total: { distance: `${longRunTotalDistance.toFixed(1)} km` }
                        };
                    } else {
                        const scaledTraining = scaleTrainingStructure(originalType, scalingFactorForSelectedMonth);
                        const totalDistance = scaledTraining.structure.reduce((sum, phase) => sum + phase.distance, 0);
                        runForCalendarDisplay = {
                            title: `üèÉ‚Äç‚ôÇÔ∏è ${originalType.name.split(': ')[1].replace('Treino ', '').trim()}`, 
                            total: { distance: `${totalDistance.toFixed(1)} km` }
                        };
                    }
                    
                    dayClass = 'bg-green-100 border border-green-200 cursor-pointer hover:bg-green-200';
                    dataAttributes = `data-run-key="${specificAmpauloRunKey}" data-day="${day}" data-month="${month}" data-year="${year}"`;
                    
                    let displayedDistance = '';
                    if (runForCalendarDisplay.total && runForCalendarDisplay.total.distance) {
                         displayedDistance = `<span class="text-xs text-teal-600 block font-bold">Meta: ${runForCalendarDisplay.total.distance}</span>`;
                    }
                    let displayName = runForCalendarDisplay.title.replace('üèÉ‚Äç‚ôÇÔ∏è', '').replace('Corrida', '').replace(/\(.+\)/, '').trim();
                    activityInfo = `<span class="text-xs text-green-800 font-semibold mt-1 block">${displayName}</span> ${displayedDistance}`;
                } else if (generalActivity) { // It's a general activity (muscula√ß√£o, Eloisa's run, or rest)
                    let activityLabel = generalActivity.activity;
                    let activityIcon = '';
                    let activityKey = ''; // Use a generic key for modal lookup

                    if (generalActivity.workoutKey && !generalActivity.runKey) {
                        activityIcon = 'üèãÔ∏è‚Äç‚ôÇÔ∏è ';
                        activityKey = generalActivity.workoutKey;
                        dataAttributes = `data-workout-key="${activityKey}" data-day="${day}" data-month="${month}" data-year="${year}"`;
                    } else if (generalActivity.runKey) {
                        activityIcon = 'üèÉ‚Äç‚ôÄÔ∏è '; // Assuming Eloisa's run
                        activityKey = generalActivity.runKey;
                        dataAttributes = `data-run-key="${activityKey}" data-day="${day}" data-month="${month}" data-year="${year}"`;
                    } else {
                        activityIcon = 'üßò '; // Default for rest/active rest
                        activityKey = `general_activity_${weekdayIndex}`; // A generic key to indicate general activity
                        dataAttributes = `data-day="${day}" data-month="${month}" data-year="${year}"`; // For general modal
                    }

                    // Shorten the activity label if too long for calendar cell
                    if (activityLabel.includes("MUSCULA√á√ÉO") && activityLabel.includes("E CORRIDA")) {
                        activityLabel = "Musc./Corr.";
                    } else if (activityLabel.includes("MUSCULA√á√ÉO")) {
                        activityLabel = "Muscula√ß√£o";
                    } else if (activityLabel.includes("CORRIDA E MUSCULA√á√ÉO")) {
                        activityLabel = "Corrida/Musc.";
                    } else if (activityLabel.includes("DESCANSO")) {
                        activityLabel = "Descanso";
                    }

                    activityInfo = `<span class="text-xs text-slate-700 font-semibold mt-1 block">${activityIcon}${activityLabel}</span>`;
                    dayClass = 'bg-blue-100 border border-blue-200 cursor-pointer hover:bg-blue-200';
                }


                calendarHtml += `<button data-day="${day}" data-month="${month}" data-year="${year}" ${dataAttributes} class="calendar-day-btn h-10 flex flex-col items-center justify-center rounded-full ${dayClass} hover:bg-teal-200 transition-colors">${day}${activityInfo}</button>`;
            }
            calendarHtml += '</div></div>';
            return calendarHtml;
        }

        function initFinancesView() {
            const container = document.getElementById('financas');
            container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-center mb-6">Suas Finan√ßas</h2>
                <div class="space-y-8">
                    <div><h3 class="text-xl font-semibold mb-4 border-b pb-2">üí∏ Contas a Pagar</h3><div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800 text-white"><tr><th class="p-2 text-left">Obriga√ß√£o</th><th class="p-2 text-left">Dia do Vencimento</th></tr></thead>
                            <tbody>${projectData.finances.billPayments.map(bill => `<tr class="border-b odd:bg-slate-50"><td class="p-2">${bill.name}</td><td class="p-2">${bill.day}</td></tr>`).join('')}</tbody>
                        </table></div></div>
                    <div><h3 class="text-xl font-semibold mb-4 border-b pb-2">üí≥ Cart√µes de Cr√©dito</h3><div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-800 text-white"><tr><th class="p-2 text-left">Cart√£o</th><th class="p-2 text-left">Vencimento</th><th class="p-2 text-left">Fechamento</th></tr></thead>
                            <tbody>${projectData.finances.creditCardInfo.map(card => `<tr class="border-b odd:bg-slate-50"><td class="p-2">${card.name}</td><td class="p-2">Dia ${card.maturityDay}</td><td class="p-2">Dia ${card.closingDay}</td></tr>`).join('')}</tbody>
                        </table></div></div>
                </div></div>`;
            lucide.createIcons(); 
        }

        // --- Modal Functions (UNIFIED) ---

        // Unified function to display activity details in the modal
        function showActivityModal(clickedElement) {
            const day = parseInt(clickedElement.dataset.day);
            const month = parseInt(clickedElement.dataset.month);
            const year = parseInt(clickedElement.dataset.year);
            const date = new Date(year, month, day);
            const weekdayIndex = date.getDay();

            const modal = document.getElementById('calendar-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalActivity = document.getElementById('modal-activity');
            const modalMotivation = document.getElementById('modal-motivation');
            const modalVerseRef = document.getElementById('modal-verse-ref');
            const modalFinances = document.getElementById('modal-finances');

            modalTitle.textContent = `${getDayName(date)}, ${day} de ${getMonthName(date)}`;
            modalMotivation.textContent = '';
            modalVerseRef.textContent = '';
            modalFinances.innerHTML = '';
            modalActivity.innerHTML = ''; // Clear previous content

            const runKey = clickedElement.dataset.runKey;
            const workoutKey = clickedElement.dataset.workoutKey;
            
            if (runKey) { // Display Running Training
                const isAmpauloRun = runKey.startsWith('ampaulo_'); 
                let runToDisplay;

                if (isAmpauloRun) {
                    const targetDistanceForSelectedMonth = getTargetLongaoDistanceForMonth(month, year);
                    const originalTypeKey = runKey.replace('ampaulo_', ''); 
                    const originalTrainingType = projectData.virtualCoach.trainingTypes[originalTypeKey];
                    let scaledStructure;

                    if (originalTypeKey === 'longao') {
                        scaledStructure = generateLongaoStructure(targetDistanceForSelectedMonth);
                    } else {
                        const initialLongaoBaseDistance = projectData.virtualCoach.trainingTypes.longao.baseDistance;
                        const scalingFactor = targetDistanceForSelectedMonth / initialLongaoBaseDistance;
                        scaledStructure = scaleTrainingStructure(originalTrainingType, scalingFactor).structure;
                    }

                    const totalDistance = scaledStructure.reduce((sum, phase) => {
                        const distValue = parseFloat(phase.distance);
                        return sum + (isNaN(distValue) ? 0 : distValue);
                    }, 0);
                    const totalTimeSeconds = scaledStructure.reduce((sum, phase) => {
                        const timeStr = calculateEstimatedTime(phase.distance, phase.zone);
                        const [min, sec] = timeStr.split(':').map(Number);
                        return sum + (min * 60) + sec;
                    }, 0);
                    const totalMinutes = Math.floor(totalTimeSeconds / 60);
                    const totalSecondsRemainder = Math.round(totalTimeSeconds % 60);

                    runToDisplay = {
                        key: runKey,
                        title: `üèÉ‚Äç‚ôÇÔ∏è ${originalTrainingType.name.split(': ')[1]} (${getMonthName(date)} - Escalada)`,
                        objective: originalTrainingType.description,
                        total: { duration: `${totalMinutes} min ${totalSecondsRemainder.toString().padStart(2, '0')} sec`, distance: `${totalDistance.toFixed(1)} km` },
                        stages: scaledStructure.map(phase => ({
                            km: (typeof phase.distance === 'number')
                                ? (phase.distance === Math.floor(phase.distance) ? String(phase.distance) : phase.distance.toFixed(1))
                                : String(phase.phase),
                            name: phase.description,
                            pace: `${projectData.runs.paceDefinitionsAmpaulo.find(def => def.name.startsWith(phase.zone)).min_km}-${projectData.runs.paceDefinitionsAmpaulo.find(def => def.name.startsWith(phase.zone)).max_km}`,
                            zone: phase.zone,
                            estimated_time: calculateEstimatedTime(phase.distance, phase.zone)
                        }))
                    };

                    if (originalTypeKey === 'longao') {
                        runToDisplay.title = `üèÉ‚Äç‚ôÇÔ∏è Corrida Longa (${getMonthName(date)} - Meta ${targetDistanceForSelectedMonth}km)`;
                    }

                } else {
                    runToDisplay = projectData.runs[runKey];
                }

                if (runToDisplay) {
                    modalActivity.innerHTML = `<strong>Tipo:</strong> Corrida<br>${generateRunHTML(runToDisplay, isAmpauloRun)}`;
                } else {
                    modalActivity.innerHTML = 'Nenhum plano de corrida encontrado para este dia.';
                }
            } else if (workoutKey) { // Display Gym Workout
                const workout = projectData.workouts[workoutKey];
                if (workout) {
                    modalActivity.innerHTML = `<strong>Tipo:</strong> Muscula√ß√£o<br>${generateWorkoutHTML(workout, true)}`;
                } else {
                    modalActivity.innerHTML = 'Nenhum treino de muscula√ß√£o encontrado para este dia.';
                }
            } else { // Display General Activity or Rest Day
                const dayData = projectData.calendarActivities[weekdayIndex] || { msg: "Dia de descanso.", verse: "" };
                modalActivity.innerHTML = `<strong>Atividade:</strong> ${dayData.activity || 'Dia de Descanso'}`;
                modalMotivation.textContent = dayData.msg || '';
                modalVerseRef.textContent = dayData.verse ? `"${dayData.verse}"` : "";
            }

            // Always display financial obligations if any for the day
            const obligations = projectData.finances.billPayments.filter(b => b.day == day);
            if(obligations.length > 0) {
                modalFinances.innerHTML = `<h4 class="font-semibold text-slate-700 mt-4 border-t pt-4">Obriga√ß√µes Financeiras:</h4><ul class="list-disc list-inside text-red-600">${obligations.map(o => `<li>${o.name}</li>`).join('')}</ul>`;
            } else {
                modalFinances.innerHTML = `<p class="text-slate-500 mt-4 border-t pt-4">Nenhuma obriga√ß√£o financeira para este dia.</p>`;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons(); // Re-create icons for new modal content
        }
    </script>
</body>
</html>
